{contentType text}
{extends 'components.widget-base'}
{php $doNotPause = true;}
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<manialink version="3">
    {block id}maps{/block}
    {block size}44 8{/block}

    {block content}
    <quad id="bg" pos="0 0" size="36 8" bgcolor="{config('colors.ui.widget.bg.color')}" opacity="{config('colors.ui.widget.bg.opacity') - 0.15}" z-index="-1"/>
    <quad id="header" pos="36 0" size="8 8" bgcolor="{config('colors.ui.widget.header.color')}e" z-index="-1"/>

    <label id="map-name" pos="35 -1.5" z-index="1" size="36 3" scale="0.8" text="Map name" halign="right" textcolor="eeee" textsize="1.4"
           textfont="{config('colors.ui.font')|noescape}"/>
    <label id="author-name" pos="35 -5.5" z-index="1" size="36 3" scale="0.8" text="Author name" halign="right" textcolor="dddd" valign="center"
           textsize="0.6" textfont="{config('colors.ui.font')|noescape}"/>

    <label pos="40 -4" valign="center" halign="center" textsize="2" size="6 6" scale="0.8" text="ï‰¹" textcolor="{config('colors.ui.widget.text.primary')}"
           textfont="{config('colors.ui.font')|noescape}"/>

    <frame id="controls" pos="5 -8.5" z-index="10">
        <quad pos="-5 0" size="36 8" bgcolor="{config('colors.ui.window.bg.color')|noescape}6" z-index="-1"/>
        <quad pos="-5 0" size="36 8" bgcolor="{config('colors.ui.window.header.color')}6" z-index="-2"/>

        <frame pos="0 -4">
            <label class="map-control quick-fav" textsize="1.5" size="12 8" text="" z-index="0" halign="center"
                   valign="center" ScriptEvents="1" focusareacolor1="0000"
                   focusareacolor2="{config('colors.ui.window.header.color')}9"/>
            <label id="fav-button" pos="0 1.5" textsize="1" size="10 10" text="ï‚Š" z-index="1" halign="center"
                   valign="center"/>
            <label id="fav-text" textfont="{config('colors.ui.font')|noescape}" pos="0 -2" textsize="1" scale="0.6" size="10 10" text="Add"
                   z-index="1"
                   halign="center" valign="center"/>
        </frame>

        <frame pos="12.5 -4">
            <label class="map-control details" textsize="1.5" size="12 8" text="" z-index="0" halign="center"
                   valign="center" ScriptEvents="1" focusareacolor1="0000"
                   focusareacolor2="{config('colors.ui.window.header.color')}9"/>
            <label pos="0 1.5" textsize="1" size="10 10" text="ï…œ" z-index="1" halign="center" valign="center"/>
            <label textfont="{config('colors.ui.font')|noescape}" pos="0 -2" textsize="1" scale="0.6" size="10 10" text="Details"
                   z-index="1" halign="center" valign="center"/>
        </frame>

        <frame pos="25 -4">
            <label class="map-control list" textsize="1.5" size="12 8" text="" z-index="0" halign="center"
                   valign="center" ScriptEvents="1" focusareacolor1="0000"
                   focusareacolor2="{config('colors.ui.window.header.color')}9"/>
            <label pos="0 1.5" textsize="1" size="10 10" text="ïƒŠ" z-index="1" halign="center" valign="center"/>
            <label textfont="{config('colors.ui.font')|noescape}" pos="0 -2" textsize="1" scale="0.6" size="10 10" text="Maps" z-index="1"
                   halign="center" valign="center"/>
        </frame>
    </frame>
    {/block}

    {block script}
    <framemodel id="Map">
        <quad valign="center" pos="-2 0" size="200 4.5" bgcolor="{config('colors.ui.window.header.color')|noescape}" opacity="0"/>
        <label pos="1 0" valign="center" size="40 3" text="map name lol asdfasdasdsad" textcolor="{config('colors.ui.window.text.primary')}"
               textsize="0.6" z-index="1" textfont="{config('colors.ui.font')|noescape}"/>
        <label pos="52 0" valign="center" size="30 3" text="map author name comes here" textcolor="{config('colors.ui.window.text.primary')}"
               textsize="0.6" z-index="1" textfont="{config('colors.ui.font')|noescape}"
               ScriptEvents="1" focusareacolor1="0000" focusareacolor2="{config('colors.ui.window.header.color')}3"
               class="filter-author"/>
        <label pos="88 0" valign="center" size="30 3" halign="center" text="local" textcolor="{config('colors.ui.window.text.primary')}" textsize="0.6"
               z-index="1" textfont="{config('colors.ui.font')|noescape}"/>
        <label pos="96 0" valign="center" size="30 3" halign="center" text="dedi" textcolor="{config('colors.ui.window.text.primary')}" textsize="0.6"
               z-index="1" textfont="{config('colors.ui.font')|noescape}"/>
        <label class="fav" pos="115.5 0" valign="center" size="3 3" text="ï‚Š" textcolor="{config('colors.ui.window.text.primary')}" textsize="0.6"
               z-index="1" ScriptEvents="1" focusareacolor1="0000" focusareacolor2="0000" textfont="{config('colors.ui.font')|noescape}"/>
        <label pos="106 0" valign="center" size="30 3" halign="center" text="â™¦â™¦â™¦â™¦â™¦" textcolor="{config('colors.ui.window.text.primary')}" textsize="0.6"
               z-index="1" textfont="{config('colors.ui.font')|noescape}"/>

        <frame id="buttons" pos="120 0" z-index="5">
            <label textfont="{config('colors.ui.font')|noescape}" class="btn juke" data-tab="01" size="11 3" text="ï‚ Juke" textsize="0.3" textcolor="{config('colors.ui.window.text.primary')}"
                   valign="center" halign="center" ScriptEvents="1" focusareacolor1="{config('colors.ui.window.header.color')}3"
                   focusareacolor2="{config('colors.ui.window.header.color')}9"/>
            <label textfont="{config('colors.ui.font')|noescape}" class="btn info" data-tab="012" size="10 3" text="ïƒ† Info" textsize="0.3" textcolor="{config('colors.ui.window.text.primary')}"
                   valign="center" halign="center" ScriptEvents="1" focusareacolor1="{config('colors.ui.window.header.color')}3"
                   focusareacolor2="{config('colors.ui.window.header.color')}9"/>
            {if $localPlayer->hasAccess('map_disable') || $localPlayer->hasAccess('map_delete')}
            <label textfont="{config('colors.ui.font')|noescape}" class="btn delete" data-tab="01" size="4 3" text="ï€”" textsize="0.3" textcolor="{config('colors.ui.window.text.primary')}"
                   valign="center" halign="center" ScriptEvents="1" focusareacolor1="f003" focusareacolor2="f009"/>
            {/if}
        </frame>
    </framemodel>

    <framemodel id="QueueItem">
        <quad valign="center" pos="-2 0" size="200 4.5" bgcolor="{config('colors.ui.window.header.color')|noescape}" opacity="0"/>
        <label pos="1 0" valign="center" size="40 3" text="map name lol asdfasdasdsad asdfasdasdsad asdfasdas"
               textcolor="{config('colors.ui.window.text.primary')}"
               textsize="0.6" z-index="1" textfont="{config('colors.ui.font')|noescape}"/>
        <label pos="44 0" valign="center" size="30 3" text="map author name comes here map author" textcolor="{config('colors.ui.window.text.primary')}"
               textsize="0.6" z-index="1" textfont="{config('colors.ui.font')|noescape}"/>
        <label pos="80 0" valign="center" size="30 3" halign="center" text="local" textcolor="{config('colors.ui.window.text.primary')}" textsize="0.6"
               z-index="1" textfont="{config('colors.ui.font')|noescape}"/>
        <label pos="88 0" valign="center" size="30 3" halign="center" text="dedi" textcolor="{config('colors.ui.window.text.primary')}" textsize="0.6"
               z-index="1" textfont="{config('colors.ui.font')|noescape}"/>
        <label pos="94 0" valign="center" size="24 3" text="requested by requested by requested by" textcolor="{config('colors.ui.window.text.primary')}"
               textsize="0.6" z-index="1" textfont="{config('colors.ui.font')|noescape}"/>

        <frame id="queue-buttons" pos="120 0" z-index="5">
            <label textfont="{config('colors.ui.font')|noescape}" class="btn drop" data-tab="2" size="11 3" text="ï‚‹ Drop" textsize="0.3" textcolor="{config('colors.ui.window.text.primary')}"
                   valign="center" halign="center" ScriptEvents="1" focusareacolor1="f003" focusareacolor2="f009"/>
            <label textfont="{config('colors.ui.font')|noescape}" class="btn info" data-tab="012" size="10 3" text="ïƒ† Info" textsize="0.3" textcolor="{config('colors.ui.window.text.primary')}"
                   valign="center" halign="center" ScriptEvents="1" focusareacolor1="{config('colors.ui.window.header.color')}3"
                   focusareacolor2="{config('colors.ui.window.header.color')}9"/>
        </frame>
    </framemodel>

    <frame id="map-list-window" pos="-20 55" size="122 106" hidden="1" z-index="300" scale="1.1">
        <quad id="handle" data-id="maps" pos="0 0" size="1 6" z-index="1"/>
        <quad pos="0 0" size="200 11" bgcolor="{config('colors.ui.window.header.color')|noescape}" opacity="0.9" z-index="-2"/>
        <quad pos="0 -10.5" size="200 0.5" bgcolor="{config('colors.ui.window.header.color')|noescape}" z-index="2"/>
        <quad pos="0 0" size="200 150" bgcolor="{config('colors.ui.window.bg.color')|noescape}" opacity="0.7"/>
        <quad pos="0 0" size="200 150" style="Bgs1" substyle="BgDialogBlur"/>
        <label pos="1.5 -3" size="20 5" text="ï‰¹ Maps" valign="center" textsize="1.2" z-index="2" textcolor="{config('colors.ui.window.header.text')}"
               textfont="{config('colors.ui.font')|noescape}"/>
        <label id="close" class="close" pos="119 -3" size="6 6" text="âŒ" textsize="1.2" z-index="50" valign="center"
               halign="center" textcolor="{config('colors.ui.window.header.text')}" focusareacolor1="0000" focusareacolor2="{config('colors.ui.window.header.color')}f"
               ScriptEvents="1"/>

        <frame id="navbar" pos="0 -5.5" z-index="5">
            <label textfont="{config('colors.ui.font')|noescape}" class="nav-btn" pos="10 -3" textsize="0.3" textcolor="{config('colors.ui.window.text.primary')}" data-tab="0"
                   text="Maps" valign="center" halign="center" size="15 4" ScriptEvents="1"
                   focusareacolor1="{config('colors.ui.window.header.color')}3" focusareacolor2="{config('colors.ui.window.header.color')}c"/>
            <label textfont="{config('colors.ui.font')|noescape}" class="nav-btn" pos="27 -3" textsize="0.3" textcolor="{config('colors.ui.window.text.primary')}" data-tab="1"
                   text="Favorites" valign="center" halign="center" size="15 4" ScriptEvents="1"
                   focusareacolor1="{config('colors.ui.window.header.color')}3" focusareacolor2="{config('colors.ui.window.header.color')}c"/>
            <label textfont="{config('colors.ui.font')|noescape}" class="nav-btn" pos="44 -3" textsize="0.3" textcolor="{config('colors.ui.window.text.primary')}" data-tab="2"
                   text="Juked maps" valign="center" halign="center" size="15 4" ScriptEvents="1"
                   focusareacolor1="{config('colors.ui.window.header.color')}3" focusareacolor2="{config('colors.ui.window.header.color')}c"/>
            <quad id="nav-active" pos="10 -3" size="15 4" bgcolor="{config('colors.ui.window.header.color')}f" z-index="-1"
                  halign="center" valign="center"/>
        </frame>

        <frame id="maps-all" pos="2 -13" z-index="2">
            <frame scale="0.97" pos="0 -6">
                <label pos="1  1" textsize="1" text="Name" scale="0.8" textcolor="{config('colors.ui.window.header.color')}"
                       textfont="{config('colors.ui.font')|noescape}"/>
                <label pos="52 1" textsize="1" text="Author" scale="0.8" textcolor="{config('colors.ui.window.header.color')}"
                       textfont="{config('colors.ui.font')|noescape}"/>
                <label pos="88 1" textsize="1" text="Local" halign="center" scale="0.8"
                       textcolor="{config('colors.ui.window.header.color')}" textfont="{config('colors.ui.font')|noescape}"/>
                <label pos="96 1" textsize="1" text="Dedi" halign="center" scale="0.8"
                       textcolor="{config('colors.ui.window.header.color')}" textfont="{config('colors.ui.font')|noescape}"/>
                <label pos="106 1" textsize="1" text="Karma" halign="center" scale="0.8"
                       textcolor="{config('colors.ui.window.header.color')}" textfont="{config('colors.ui.font')|noescape}"/>
                <label pos="117 1" textsize="1" text="Favorite" halign="center" scale="0.8"
                       textcolor="{config('colors.ui.window.header.color')}" textfont="{config('colors.ui.font')|noescape}"/>

                <frame id="sorting-controls" pos="-1 5.25">
                    <quad valign="center" pos="-1" size="200 6" textcolor="{config('colors.ui.window.bg.color')}" opacity="{config('colors.ui.window.bg.opacity') - 0.1}" z-index="-1"/>
                    <label pos="2 0" textsize="1" text="Sort/Filter:" scale="0.8" textcolor="{config('colors.ui.window.text.primary')}"
                           textfont="{config('colors.ui.font')|noescape}" valign="center"/>

                    <label class="filter-btn" data-sort="all" pos="20" size="13 4" textsize="0.7" text="Show All"
                           scale="0.8" textcolor="{config('colors.ui.window.text.primary')}"
                           textfont="{config('colors.ui.font')|noescape}" valign="center" halign="center" ScriptEvents="1"
                           focusareacolor1="{config('colors.ui.window.header.color')}3"
                           focusareacolor2="{config('colors.ui.window.header.color')}c"/>
                    <label class="filter-btn" data-sort="nofinish" pos="32" size="15 4" textsize="0.7"
                           text="No Finish" scale="0.8" textcolor="{config('colors.ui.window.text.primary')}"
                           textfont="{config('colors.ui.font')|noescape}" valign="center" halign="center" ScriptEvents="1"
                           focusareacolor1="{config('colors.ui.window.header.color')}3"
                           focusareacolor2="{config('colors.ui.window.header.color')}c"/>

                    <label pos="43" size="11 4" textsize="0.7" text=" Locals" scale="0.8" textcolor="{config('colors.ui.window.text.primary')}"
                           textfont="{config('colors.ui.font')|noescape}" valign="center" halign="center" ScriptEvents="1"
                           focusareacolor1="{config('colors.ui.window.header.color')}3"
                           focusareacolor2="{config('colors.ui.window.header.color')}3"/>
                    <label class="filter-btn" data-sort="best" pos="49.2" size="4 4" textsize="0.7" text="ï‚ª" scale="0.8"
                           textcolor="{config('colors.ui.window.text.primary')}"
                           textfont="{config('colors.ui.font')|noescape}" valign="center" halign="center" ScriptEvents="1"
                           focusareacolor1="{config('colors.ui.window.header.color')}3"
                           focusareacolor2="{config('colors.ui.window.header.color')}c"/>
                    <label class="filter-btn" data-sort="worst" pos="52.6" size="4 4" textsize="0.7" text="ï‚«"
                           scale="0.8" textcolor="{config('colors.ui.window.text.primary')}"
                           textfont="{config('colors.ui.font')|noescape}" valign="center" halign="center" ScriptEvents="1"
                           focusareacolor1="{config('colors.ui.window.header.color')}3"
                           focusareacolor2="{config('colors.ui.window.header.color')}c"/>

                    <label pos="59.4" size="11 4" textsize="0.7" text=" Dedis" scale="0.8" textcolor="{config('colors.ui.window.text.primary')}"
                           textfont="{config('colors.ui.font')|noescape}" valign="center" halign="center" ScriptEvents="1"
                           focusareacolor1="{config('colors.ui.window.header.color')}3"
                           focusareacolor2="{config('colors.ui.window.header.color')}3"/>
                    <label class="filter-btn" data-sort="best_dedi" pos="65.6" size="4 4" textsize="0.7" text="ï‚ª"
                           scale="0.8" textcolor="{config('colors.ui.window.text.primary')}"
                           textfont="{config('colors.ui.font')|noescape}" valign="center" halign="center" ScriptEvents="1"
                           focusareacolor1="{config('colors.ui.window.header.color')}3"
                           focusareacolor2="{config('colors.ui.window.header.color')}c"/>
                    <label class="filter-btn" data-sort="worst_dedi" pos="69" size="4 4" textsize="0.7" text="ï‚«"
                           scale="0.8" textcolor="{config('colors.ui.window.text.primary')}"
                           textfont="{config('colors.ui.font')|noescape}" valign="center" halign="center" ScriptEvents="1"
                           focusareacolor1="{config('colors.ui.window.header.color')}3"
                           focusareacolor2="{config('colors.ui.window.header.color')}c"/>
                </frame>

                <frame id="map-list" pos="0 -3">
                    {for $i = 0; $i<20; $i++}
                    <frameinstance pos="0 {$i * -4 - 2}" modelid="Map" hidden="0"/>
                    {/for}
                </frame>

                <frame id="pagination" pos="2 -86.5" scale="0.9">
                    <entry id="page-input" class="page-input" pos="6 0" size="8 3.5" valign="center" halign="center"
                           text="1" textsize="0.8" focusareacolor1="0000" focusareacolor2="0009" ScriptEvents="1" textcolor="{config('colors.ui.window.text.primary')}"
                           hidden="1"/>
                    <label id="page-info" class="enable-page-input" pos="6 0" size="8 3.5" valign="center"
                           halign="center" text="1/1" textsize="0.8" focusareacolor1="0000" focusareacolor2="0009" textcolor="{config('colors.ui.window.text.primary')}"
                           ScriptEvents="1"/>
                    <label class="previous-page" pos="0 0" size="3.5 3.5" valign="center" halign="center" text="â´"
                           textsize="1" ScriptEvents="1" focusareacolor1="{config('colors.ui.window.header.color')}3" textcolor="{config('colors.ui.window.text.primary')}"
                           focusareacolor2="{config('colors.ui.window.header.color')}c"/>
                    <label class="next-page" pos="12 0" size="3.5 3.5" valign="center" halign="center" text="âµ"
                           textsize="1" ScriptEvents="1" focusareacolor1="{config('colors.ui.window.header.color')}3" textcolor="{config('colors.ui.window.text.primary')}"
                           focusareacolor2="{config('colors.ui.window.header.color')}c"/>
                </frame>

                <frame id="search-frame" pos="124 -86.5" scale="0.9">
                    <label textfont="{config('colors.ui.font')|noescape}" pos="30 0" halign="right" valign="center" textsize="0.9" text="ðŸ”" textcolor="{config('colors.ui.window.text.primary')}"/>
                    <entry textfont="{config('colors.ui.font')|noescape}" id="search-input" class="search-input" pos="26.5 0" size="25 3.5" textcolor="{config('colors.ui.window.text.primary')}"
                           halign="right" valign="center" style="TextValueSmall" default="" textsize="1.2"/>
                    <label textfont="{config('colors.ui.font')|noescape}" id="clear-search" class="clear-search" pos="0 0" size="3.5 3.5" textcolor="{config('colors.ui.window.text.primary')}"
                           halign="center" valign="center" textsize="0.25" text="ïƒ¢" focusareacolor1="f003"
                           focusareacolor2="f009" ScriptEvents="1" hidden="1"/>
                </frame>
            </frame>
        </frame>

        <frame id="maps-queue" pos="2 -13" z-index="2" hidden="1">
            <frame scale="0.97" pos="0 -2">
                <label pos="1  1" textsize="1" text="Name" scale="0.8" textcolor="{config('colors.ui.window.header.color')}"
                       textfont="{config('colors.ui.font')|noescape}"/>
                <label pos="44 1" textsize="1" text="Author" scale="0.8" textcolor="{config('colors.ui.window.header.color')}"
                       textfont="{config('colors.ui.font')|noescape}"/>
                <label pos="80 1" textsize="1" text="Local" halign="center" scale="0.8"
                       textcolor="{config('colors.ui.window.header.color')}" textfont="{config('colors.ui.font')|noescape}"/>
                <label pos="88 1" textsize="1" text="Dedi" halign="center" scale="0.8"
                       textcolor="{config('colors.ui.window.header.color')}" textfont="{config('colors.ui.font')|noescape}"/>
                <label pos="94 1" textsize="1" text="Requested by" halign="left" scale="0.8"
                       textcolor="{config('colors.ui.window.header.color')}" textfont="{config('colors.ui.font')|noescape}"/>
                <label pos="120 1" textsize="1" text="Actions" halign="left" scale="0.8"
                       textcolor="{config('colors.ui.window.header.color')}" textfont="{config('colors.ui.font')|noescape}"/>

                <frame id="queue-list" pos="0 -3">
                    {for $i = 0; $i<22; $i++}
                    <frameinstance pos="0 {$i * -4 - 2}" modelid="QueueItem" hidden="1"/>
                    {/for}
                </frame>
            </frame>
        </frame>
    </frame>

    <frame id="delete-dialog" pos="-40 9" z-index="1000" hidden="1">
        <quad size="80 20" bgcolor="{config('colors.ui.window.bg.color')}" opacity="0.9" z-index="-1"/>
        <quad size="80 2" bgcolor="{config('colors.ui.window.header.color')}" opacity="0.9" z-index="0"/>
        <label pos="40 -5" size="76" valign="center" halign="center" text="" textsize="1" z-index="1"/>
        <label class="perm" pos="40 -9" size="76" valign="center" halign="center"
               text="ïƒˆ Delete permanently and from all MatchSettings" data-set="0" textsize="1" z-index="1" scale="0.7"
               focusareacolor1="0000" focusareacolor2="0000" ScriptEvents="1" hidden="0"/>

        <label class="confirm" pos="32 -15" z-index="0" size="15 5" text="YES" ScriptEvents="1"
               focusareacolor1="07E20099" halign="center" valign="center" textsize="0.5" focusareacolor2="06BD00AA"
               scriptevents="1"/>
        <label class="cancel" pos="48 -15" z-index="0" size="15 5" text="NO" ScriptEvents="1" focusareacolor1="f009"
               halign="center" valign="center" textsize="0.5" focusareacolor2="BD0000AA" scriptevents="1"/>
        <quad size="80 20" style="Bgs1" substyle="BgDialogBlur" z-index="-1"/>
    </frame>

    {include 'scripts.drag'}

    <script><!--

declare Integer[] favorites;
declare Text[Text][] maps;
declare Text[Text][Integer] mapAuthors;
declare Text[Text][] currentMapPool;
declare Integer lastMapQueueLength;
declare Integer currentPage;
declare Integer currentTab;
declare Real buttonsWidth;
declare CMlFrame mapListFrame;
declare Text currentMapUid;
declare Integer cooldown;
declare Text[Text] currentMap;
declare Boolean inSearch;
declare Boolean userCanDrop;

Text[Text] getAuthor(Text id){
    return mapAuthors[TL::ToInteger(id)];
}

Void updateCooldownValues(){
    for(i, 0, maps.count - 1){
        maps[i]["c"] = TL::ToText(TL::ToInteger(maps[i]["c"]) + 1);
    }
    for(i, 0, currentMapPool.count - 1){
        currentMapPool[i]["c"] = TL::ToText(TL::ToInteger(currentMapPool[i]["c"]) + 1);
    }
}

Void resetCooldown(Text[Text] map){
    if(!map.existskey("uid")){
        log("[Maps] Reset cooldown Error");
        log(map);
        return;
    }

    for(i, 0, maps.count - 1){
        if(maps[i]["uid"] == map["uid"]){
            maps[i]["c"] = "0";
        }
    }
    for(i, 0, currentMapPool.count - 1){
        if(currentMapPool[i]["uid"] == map["uid"]){
            currentMapPool[i]["c"] = "0";
        }
    }
}

Text[Text] findMapByUid(Text Uid){
    foreach(map in maps){
        if(!map.existskey("uid")){
            log("[Maps] findMapById Error " ^ Uid);
            return Text[Text];
        }

        if(map["uid"] == Uid){
            return map;
        }
    }

    return Text[Text];
}

Text[Text] findMapById(Text id){
    foreach(map in maps){
        if(!map.existskey("id")){
            log("[Maps] findMapById Error " ^ id);
            return Text[Text];
        }

        if(map["id"] == id){
            return map;
        }
    }

    return Text[Text];
}

Void updateWidget(Text[Text] map){
    if(!map.existskey("a")){
        log("[Maps] update Widget Error");
        log(map);
        return;
    }

    declare author = getAuthor(map["a"]);
    (Page.MainFrame.GetFirstChild("map-name") as CMlLabel).SetText(map["name"]);
    (Page.MainFrame.GetFirstChild("author-name") as CMlLabel).SetText(author["nick"]);

    if(favorites.exists(TL::ToInteger(map["id"]))){
        (Page.MainFrame.GetFirstChild("fav-button") as CMlLabel).SetText("ï€„");
        (Page.MainFrame.GetFirstChild("fav-text") as CMlLabel).SetText("Remove");
    }else{
        (Page.MainFrame.GetFirstChild("fav-button") as CMlLabel).SetText("ï‚Š");
        (Page.MainFrame.GetFirstChild("fav-text") as CMlLabel).SetText("Add");
    }
}
--></script>
    {/block}

    <script><!--
    {block globals}
    {/block}

    {block bootScript}
        inSearch = False;
        lastMapQueueLength = 0;
        currentPage = 0;
        currentTab = 0;
        userCanDrop = {($localPlayer->hasAccess('queue_drop') ? 'True' : 'False')|noescape};
        favorites = {$favorites|noescape};
        cooldown = {config('server.map-cooldown')};

        mapListFrame = (Page.MainFrame.GetFirstChild("map-list-window") as CMlFrame);
        declare widget = (Page.MainFrame.GetFirstChild("widget") as CMlFrame);
        declare widgetControls = (Page.MainFrame.GetFirstChild("controls") as CMlFrame);
        declare controlsVisible = False;
        declare Text[Text][] Maps for LocalUser;
        declare Text[Text][Integer] MapAuthors for LocalUser;
        declare Text MapSearchQuery for LocalUser;
        declare Integer MapUpdateTime for LocalUser = 0;
        declare lastMapUpdate = 0;

        while(Maps.count == 0){
            yield;
            hidescript();
        }

        left__ = {config('map-list.ui.position') == 'left' ? 'True' : 'False'};
        slot__ = {config('map-list.ui.slot')};
    {/block}

    {block loop}
        if(MapUpdateTime != 0 && lastMapUpdate != MapUpdateTime){
            lastMapUpdate = MapUpdateTime;
            mapAuthors = MapAuthors;
            maps = Maps;
        }

        if(currentMapUid != Map.MapInfo.MapUid && maps.count > 0){
            currentMapUid = Map.MapInfo.MapUid;
            currentMap = findMapByUid(currentMapUid);
            updateWidget(currentMap);
        }

        declare x_min = widget.RelativePosition_V3[0];
        declare x_max = widget.RelativePosition_V3[0] + (widget.Size[0] * widget.RelativeScale);
        declare y_min = widget.RelativePosition_V3[1];
        declare y_max = widget.RelativePosition_V3[1] - (widget.Size[1] * widget.RelativeScale);
        declare Boolean xInBounds = (MouseX > x_min && MouseX < x_max);
        declare Boolean yInBounds = (MouseY < y_min && MouseY > y_max);

        if(!(xInBounds && yInBounds) && controlsVisible){
            controlsVisible = False;
            AnimMgr.Add(widgetControls, " <frame pos='5.0 -8.5' /> ", 150, CAnimManager::EAnimManagerEasing::QuadOut);
        }
        if((xInBounds && yInBounds) && !controlsVisible){
            controlsVisible = True;
            AnimMgr.Add(widgetControls, " <frame pos='5.0 0.0' /> ", 150, CAnimManager::EAnimManagerEasing::QuadOut);
        }
    {/block}

    {block pendingEvents}
            if(event.Control.HasClass("details") && event.Type == CMlScriptEvent::Type::MouseClick){
                if(!currentMap.existskey("id")){
                    return;
                }
                TriggerPageAction("mx.details," ^ currentMap["id"]);
                continue;
            }

            if(event.Control.HasClass("list") && event.Type == CMlScriptEvent::Type::MouseClick){
                MapSearchQuery = " ";
                continue;
            }
    {/block}
    --></script>
</manialink>